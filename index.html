<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Function Composition Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Game Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent mb-4">
                üéÆ Function Composition Quest
            </h1>
            <p class="text-xl text-blue-200">Petualangan Seru Menguasai Fungsi Komposisi!</p>
        </div>

        <!-- Game Stats -->
        <div class="bg-black bg-opacity-30 rounded-xl p-6 mb-8 backdrop-blur-sm">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                <div class="bg-green-500 bg-opacity-20 rounded-lg p-4">
                    <div class="text-2xl font-bold text-green-400" id="score">0</div>
                    <div class="text-sm text-green-300">Skor</div>
                </div>
                <div class="bg-blue-500 bg-opacity-20 rounded-lg p-4">
                    <div class="text-2xl font-bold text-blue-400" id="level">1</div>
                    <div class="text-sm text-blue-300">Level</div>
                </div>
                <div class="bg-yellow-500 bg-opacity-20 rounded-lg p-4">
                    <div class="text-2xl font-bold text-yellow-400" id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                    <div class="text-sm text-yellow-300">Nyawa</div>
                </div>
                <div class="bg-purple-500 bg-opacity-20 rounded-lg p-4">
                    <div class="text-2xl font-bold text-purple-400" id="streak">0</div>
                    <div class="text-sm text-purple-300">Streak</div>
                </div>
                <div class="bg-orange-500 bg-opacity-20 rounded-lg p-4">
                    <div class="text-2xl font-bold text-orange-400" id="progress">1/3</div>
                    <div class="text-sm text-orange-300">Progress</div>
                </div>
            </div>
        </div>

        <!-- Game Menu -->
        <div id="gameMenu" class="space-y-6">
            <div class="bg-white bg-opacity-10 rounded-xl p-8 backdrop-blur-sm">
                <h2 class="text-3xl font-bold text-center mb-8 text-yellow-400">üéØ Pilih Mode Permainan</h2>
                
                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Speed Challenge -->
                    <div class="bg-gradient-to-br from-red-500 to-pink-600 rounded-xl p-6 cursor-pointer hover:scale-105 transition-transform" onclick="startGame('speed')">
                        <div class="text-center">
                            <div class="text-4xl mb-4">‚ö°</div>
                            <h3 class="text-xl font-bold mb-2">Speed Challenge</h3>
                            <p class="text-sm opacity-90 mb-4">3 soal per level, waktu terbatas!</p>
                            <div class="bg-white bg-opacity-20 rounded-lg p-2">
                                <p class="text-xs">‚Ä¢ 3 soal mudah-sedang</p>
                                <p class="text-xs">‚Ä¢ Timer 60 detik</p>
                                <p class="text-xs">‚Ä¢ Bonus kecepatan</p>
                            </div>
                        </div>
                    </div>

                    <!-- Adventure Mode -->
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-6 cursor-pointer hover:scale-105 transition-transform" onclick="startGame('adventure')">
                        <div class="text-center">
                            <div class="text-4xl mb-4">üó∫Ô∏è</div>
                            <h3 class="text-xl font-bold mb-2">Adventure Mode</h3>
                            <p class="text-sm opacity-90 mb-4">3 soal per lokasi dengan cerita!</p>
                            <div class="bg-white bg-opacity-20 rounded-lg p-2">
                                <p class="text-xs">‚Ä¢ Cerita RPG menarik</p>
                                <p class="text-xs">‚Ä¢ 3 soal per lokasi</p>
                                <p class="text-xs">‚Ä¢ Power-ups tersedia</p>
                            </div>
                        </div>
                    </div>

                    <!-- Boss Battle -->
                    <div class="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl p-6 cursor-pointer hover:scale-105 transition-transform" onclick="startGame('boss')">
                        <div class="text-center">
                            <div class="text-4xl mb-4">üëπ</div>
                            <h3 class="text-xl font-bold mb-2">Boss Battle</h3>
                            <p class="text-sm opacity-90 mb-4">3 serangan untuk kalahkan boss!</p>
                            <div class="bg-white bg-opacity-20 rounded-lg p-2">
                                <p class="text-xs">‚Ä¢ Soal sulit</p>
                                <p class="text-xs">‚Ä¢ 3 serangan per boss</p>
                                <p class="text-xs">‚Ä¢ Reward besar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tutorial Section -->
            <div class="bg-white bg-opacity-10 rounded-xl p-6 backdrop-blur-sm">
                <h3 class="text-2xl font-bold text-center mb-4 text-yellow-400">üìö Cara Bermain</h3>
                <div class="grid md:grid-cols-3 gap-4">
                    <div class="bg-black bg-opacity-30 rounded-lg p-4">
                        <h4 class="text-lg font-bold text-blue-400 mb-2">$(f \circ g)(x)$</h4>
                        <p class="text-sm mb-2">$f(g(x))$ - Substitusi g(x) ke f(x)</p>
                        <p class="text-xs text-gray-300">Contoh: $f(x) = 2x$, $g(x) = x+1$</p>
                        <p class="text-xs text-gray-300">$(f \circ g)(x) = 2(x+1) = 2x+2$</p>
                    </div>
                    <div class="bg-black bg-opacity-30 rounded-lg p-4">
                        <h4 class="text-lg font-bold text-green-400 mb-2">$(g \circ f)(x)$</h4>
                        <p class="text-sm mb-2">$g(f(x))$ - Substitusi f(x) ke g(x)</p>
                        <p class="text-xs text-gray-300">Contoh: $f(x) = 2x$, $g(x) = x+1$</p>
                        <p class="text-xs text-gray-300">$(g \circ f)(x) = 2x+1$</p>
                    </div>
                    <div class="bg-black bg-opacity-30 rounded-lg p-4">
                        <h4 class="text-lg font-bold text-purple-400 mb-2">$(f \circ g)(a)$</h4>
                        <p class="text-sm mb-2">Nilai numerik komposisi</p>
                        <p class="text-xs text-gray-300">Contoh: $(f \circ g)(2)$</p>
                        <p class="text-xs text-gray-300">Hitung $g(2)$ dulu, lalu $f(g(2))$</p>
                    </div>
                </div>
                <div class="mt-4 bg-gradient-to-r from-orange-500 to-red-500 bg-opacity-20 rounded-lg p-4">
                    <h4 class="text-lg font-bold text-orange-400 mb-2">$(f \circ g \circ h)(x)$ - Triple Composition</h4>
                    <p class="text-sm">$f(g(h(x)))$ - Mulai dari dalam: hitung $h(x)$, lalu $g(h(x))$, terakhir $f(g(h(x)))$</p>
                </div>
            </div>

            <!-- Leaderboard -->
            <div class="bg-white bg-opacity-10 rounded-xl p-6 backdrop-blur-sm">
                <h3 class="text-2xl font-bold text-center mb-4 text-yellow-400">üèÜ Papan Skor Tertinggi</h3>
                <div id="leaderboard" class="space-y-2">
                    <div class="flex justify-between items-center bg-white bg-opacity-10 rounded-lg p-3">
                        <span>ü•á Master Function</span>
                        <span class="font-bold">2500 pts</span>
                    </div>
                    <div class="flex justify-between items-center bg-white bg-opacity-10 rounded-lg p-3">
                        <span>ü•à Composition King</span>
                        <span class="font-bold">2100 pts</span>
                    </div>
                    <div class="flex justify-between items-center bg-white bg-opacity-10 rounded-lg p-3">
                        <span>ü•â Function Hero</span>
                        <span class="font-bold">1800 pts</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Area -->
        <div id="gameArea" class="hidden">
            <!-- Timer (Speed Mode) -->
            <div id="timerArea" class="text-center mb-6 hidden">
                <div class="bg-red-500 bg-opacity-20 rounded-xl p-4 inline-block">
                    <div class="text-3xl font-bold text-red-400" id="timer">60</div>
                    <div class="text-sm text-red-300">Detik Tersisa</div>
                </div>
            </div>

            <!-- Boss Health (Boss Mode) -->
            <div id="bossArea" class="hidden mb-6">
                <div class="bg-black bg-opacity-30 rounded-xl p-6">
                    <div class="text-center mb-4">
                        <h3 class="text-2xl font-bold text-red-400" id="bossName">Boss Name</h3>
                        <p class="text-sm text-red-300" id="bossDescription">Boss Description</p>
                    </div>
                    <div class="bg-red-900 rounded-full h-6 overflow-hidden mb-2">
                        <div class="bg-gradient-to-r from-red-500 to-red-600 h-full transition-all duration-500" id="bossHp" style="width: 100%"></div>
                    </div>
                    <div class="text-center">
                        <span class="text-red-300 text-sm" id="bossHpText">100/100 HP</span>
                    </div>
                </div>
            </div>

            <!-- Adventure Story (Adventure Mode) -->
            <div id="storyArea" class="hidden mb-6">
                <div class="bg-gradient-to-r from-green-500 to-blue-500 bg-opacity-20 rounded-xl p-6">
                    <div class="flex items-center space-x-4">
                        <div class="text-4xl" id="storyIcon">üè∞</div>
                        <div>
                            <h3 class="text-xl font-bold text-yellow-400" id="storyTitle">Lokasi</h3>
                            <p class="text-sm text-blue-200" id="storyText">Cerita petualangan...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Question Area -->
            <div class="bg-white bg-opacity-10 rounded-xl p-8 backdrop-blur-sm mb-6">
                <div class="text-center mb-6">
                    <div class="text-lg text-blue-300 mb-2" id="questionType">Tentukan Fungsi Komposisi</div>
                    <div class="text-3xl font-bold text-yellow-400" id="questionNumber">Soal 1/3</div>
                </div>

                <div class="bg-black bg-opacity-30 rounded-xl p-6 mb-6">
                    <div id="functionDisplay" class="text-center space-y-4">
                        <div class="text-xl">
                            <span class="text-blue-300">f(x) = </span>
                            <span id="funcF" class="text-white font-mono">2x + 1</span>
                        </div>
                        <div class="text-xl">
                            <span class="text-green-300">g(x) = </span>
                            <span id="funcG" class="text-white font-mono">x - 3</span>
                        </div>
                        <div class="text-2xl text-yellow-400 mt-4">
                            Tentukan: <span id="questionTarget">(f ‚àò g)(x)</span>
                        </div>
                    </div>
                </div>

                <!-- Answer Options -->
                <div id="answerOptions" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Options will be generated dynamically -->
                </div>
            </div>

            <!-- Power-ups (Adventure & Boss Mode) -->
            <div id="powerupsArea" class="bg-white bg-opacity-10 rounded-xl p-6 backdrop-blur-sm mb-6 hidden">
                <h3 class="text-lg font-bold text-yellow-400 mb-4">üîÆ Power-ups</h3>
                <div class="grid grid-cols-3 gap-4">
                    <button id="hint-btn" onclick="useHint()" class="bg-blue-500 bg-opacity-30 hover:bg-opacity-50 rounded-lg p-3 transition-all">
                        <div class="text-2xl">üí°</div>
                        <div class="text-xs">Hint</div>
                        <div class="text-xs" id="hintCount">3</div>
                    </button>
                    <button id="skip-btn" onclick="skipQuestion()" class="bg-yellow-500 bg-opacity-30 hover:bg-opacity-50 rounded-lg p-3 transition-all">
                        <div class="text-2xl">‚è≠Ô∏è</div>
                        <div class="text-xs">Skip</div>
                        <div class="text-xs" id="skipCount">2</div>
                    </button>
                    <button id="double-btn" onclick="activateDouble()" class="bg-purple-500 bg-opacity-30 hover:bg-opacity-50 rounded-lg p-3 transition-all">
                        <div class="text-2xl">‚ú®</div>
                        <div class="text-xs">2x Skor</div>
                        <div class="text-xs" id="doubleCount">1</div>
                    </button>
                </div>
            </div>

            <!-- Back to Menu -->
            <div class="text-center">
                <button onclick="backToMenu()" class="bg-gray-500 bg-opacity-30 hover:bg-opacity-50 text-white font-bold py-3 px-6 rounded-xl transition-all">
                    üè† Kembali ke Menu
                </button>
            </div>
        </div>

        <!-- Level Complete Screen -->
        <div id="levelCompleteScreen" class="hidden">
            <div class="bg-white bg-opacity-10 rounded-xl p-8 backdrop-blur-sm text-center">
                <div class="text-6xl mb-4">üéä</div>
                <h2 class="text-4xl font-bold mb-4 text-yellow-400">Level Selesai!</h2>
                <div class="text-2xl mb-6">
                    <div class="text-green-400">Level <span id="completedLevel" class="font-bold">1</span> - <span id="completedMode" class="font-bold">Mode</span></div>
                    <div class="text-blue-400 mt-2">Skor Level: <span id="levelScore" class="font-bold">0</span></div>
                </div>
                
                <div class="bg-black bg-opacity-30 rounded-xl p-6 mb-6">
                    <h3 class="text-xl font-bold text-yellow-400 mb-4">üìä Hasil Level</h3>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div>
                            <div class="text-2xl font-bold text-green-400" id="levelCorrect">0</div>
                            <div>Benar</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-red-400" id="levelWrong">0</div>
                            <div>Salah</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-blue-400" id="levelAccuracy">0%</div>
                            <div>Akurasi</div>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-purple-500 to-pink-500 bg-opacity-20 rounded-xl p-4 mb-6">
                    <p class="text-lg">üéØ Kembali ke menu untuk memilih level atau mode lain!</p>
                    <p class="text-sm text-gray-300 mt-2">Otomatis kembali dalam <span id="countdown">3</span> detik...</p>
                </div>

                <button onclick="backToMenu()" class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-4 px-8 rounded-xl transition-all">
                    üè† Kembali ke Menu Sekarang
                </button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="hidden">
            <div class="bg-white bg-opacity-10 rounded-xl p-8 backdrop-blur-sm text-center">
                <div class="text-6xl mb-4" id="gameOverEmoji">üéâ</div>
                <h2 class="text-4xl font-bold mb-4" id="gameOverTitle">Permainan Selesai!</h2>
                <div class="text-2xl mb-6">
                    <div class="text-yellow-400">Skor Akhir: <span id="finalScore" class="font-bold">0</span></div>
                    <div class="text-blue-400 mt-2">Level Tertinggi: <span id="finalLevel" class="font-bold">1</span></div>
                </div>
                
                <div class="bg-black bg-opacity-30 rounded-xl p-6 mb-6">
                    <h3 class="text-xl font-bold text-yellow-400 mb-4">üìä Statistik Permainan</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>Soal Dijawab: <span id="totalAnswered" class="font-bold">0</span></div>
                        <div>Jawaban Benar: <span id="totalCorrect" class="font-bold">0</span></div>
                        <div>Akurasi: <span id="accuracy" class="font-bold">0%</span></div>
                        <div>Streak Terpanjang: <span id="maxStreak" class="font-bold">0</span></div>
                    </div>
                </div>

                <div class="space-y-4">
                    <button onclick="restartGame()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-8 rounded-xl transition-all">
                        üîÑ Main Lagi
                    </button>
                    <button onclick="backToMenu()" class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-4 px-8 rounded-xl transition-all">
                        üè† Menu Utama
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            mode: '',
            score: 0,
            level: 1,
            lives: 3,
            streak: 0,
            maxStreak: 0,
            totalAnswered: 0,
            totalCorrect: 0,
            currentQuestion: {},
            timer: 60,
            timerInterval: null,
            powerups: {
                hints: 3,
                skips: 2,
                double: 1
            },
            doubleActive: false,
            boss: {
                name: '',
                maxHp: 100,
                currentHp: 100
            },
            questionsInLevel: 0, // Track questions answered in current level
            maxQuestionsPerLevel: 3, // Exactly 3 questions per level
            levelStartScore: 0, // Score at start of level
            levelCorrectAnswers: 0, // Correct answers in current level
            levelWrongAnswers: 0, // Wrong answers in current level
            countdownInterval: null // For auto-return countdown
        };

        // Question banks - 3 questions per level for each mode
        const speedQuestions = {
            1: [
                {
                    f: "x + 1", g: "x + 2", answer: "x + 3", type: "fog",
                    options: ["x + 1", "x + 3", "x + 2", "2x + 1"],
                    question: "(f ‚àò g)(x)"
                },
                {
                    f: "x + 3", g: "x + 1", answer: "x + 4", type: "gof",
                    options: ["x + 3", "x + 1", "x + 4", "2x + 4"],
                    question: "(g ‚àò f)(x)"
                },
                {
                    f: "2x", g: "x + 1", answer: "3", type: "numerical",
                    options: ["1", "2", "3", "4"],
                    question: "(f ‚àò g)(1)", value: 1
                }
            ],
            2: [
                {
                    f: "2x", g: "x + 1", answer: "2x + 2", type: "fog",
                    options: ["2x + 1", "3x + 1", "2x + 2", "x + 2"],
                    question: "(f ‚àò g)(x)"
                },
                {
                    f: "x + 2", g: "2x", answer: "4x + 2", type: "gof",
                    options: ["3x + 2", "2x", "x + 4", "4x + 2"],
                    question: "(g ‚àò f)(x)"
                },
                {
                    f: "x - 1", g: "2x + 3", answer: "7", type: "numerical",
                    options: ["5", "6", "7", "8"],
                    question: "(f ‚àò g)(2)", value: 2
                }
            ],
            3: [
                {
                    f: "x - 1", g: "x + 2", answer: "x + 1", type: "fog",
                    options: ["x - 1", "x + 2", "x + 1", "2x + 1"],
                    question: "(f ‚àò g)(x)"
                },
                {
                    f: "2x + 1", g: "x", answer: "2x + 1", type: "gof",
                    options: ["2x", "2x + 1", "x + 1", "3x + 1"],
                    question: "(g ‚àò f)(x)"
                },
                {
                    f: "3x - 2", g: "x + 1", answer: "4", type: "numerical",
                    options: ["2", "3", "4", "5"],
                    question: "(f ‚àò g)(2)", value: 2
                }
            ]
        };

        const adventureQuestions = {
            1: [
                {
                    f: "x^2", g: "x + 1", answer: "x^2 + 2x + 1", type: "fog",
                    options: ["x^2 + 1", "x^2 + 2x + 1", "x^2 + x + 1", "2x^2 + 1"],
                    story: "üè∞ Kastil Ajaib: Kekuatan sihir meningkat!",
                    icon: "üè∞", question: "(f ‚àò g)(x)"
                },
                {
                    f: "2x + 3", g: "x - 1", answer: "x + 2", type: "gof",
                    options: ["2x + 3", "2x - 1", "x + 2", "3x + 2"],
                    story: "üè∞ Kastil Ajaib: Mantra perlindungan aktif!",
                    icon: "üè∞", question: "(g ‚àò f)(x)"
                },
                {
                    f: "x + 2", g: "3x", h: "x - 1", answer: "3x + 5", type: "triple",
                    options: ["4x + 2", "3x + 6", "x + 6", "3x + 5"],
                    story: "üè∞ Kastil Ajaib: Gerbang terbuka!",
                    icon: "üè∞", question: "(f ‚àò g ‚àò h)(x)"
                }
            ],
            2: [
                {
                    f: "x^2 - 1", g: "x + 2", answer: "x^2 + 4x + 3", type: "fog",
                    options: ["x^2 + 2x - 1", "x^2 + 4x + 3", "x^2 + 4x - 1", "x^2 + 2x + 3"],
                    story: "üó°Ô∏è Gua Kristal: Pedang ajaib membutuhkan formula!",
                    icon: "üíé", question: "(f ‚àò g)(x)"
                },
                {
                    f: "3x - 2", g: "2x + 1", answer: "6x - 1", type: "gof",
                    options: ["6x - 1", "5x + 1", "6x + 1", "6x - 2"],
                    story: "üó°Ô∏è Gua Kristal: Kristal berkilau terang!",
                    icon: "üíé", question: "(g ‚àò f)(x)"
                },
                {
                    f: "x^2", g: "2x", h: "x + 1", answer: "4x^2 + 16x + 16", type: "triple",
                    options: ["2x^2 - 1", "4x^2 + 16x + 16", "x^2 - 4x + 2", "2x^2 - 4x + 2"],
                    story: "üó°Ô∏è Gua Kristal: Harta karun ditemukan!",
                    icon: "üíé", question: "(f ‚àò g ‚àò h)(x)"
                }
            ],
            3: [
                {
                    f: "x^2 + x", g: "x - 2", answer: "x^2 - 3x + 2", type: "fog",
                    options: ["x^2 + x - 2", "x^2 - x - 2", "x^2 - 3x + 2", "x^2 - 2x + 1"],
                    story: "üèπ Menara Sihir: Panah elemental siap diluncurkan!",
                    icon: "üóº", question: "(f ‚àò g)(x)"
                },
                {
                    f: "4x + 1", g: "x^2", answer: "x^2 + 4", type: "gof",
                    options: ["4x^2", "x^2 + 4", "x^2 + 1", "4x + x^2"],
                    story: "üèπ Menara Sihir: Kekuatan maksimal tercapai!",
                    icon: "üóº", question: "(g ‚àò f)(x)"
                },
                {
                    f: "x - 3", g: "2x + 1", answer: "-5", type: "numerical",
                    options: ["2x + 1", "-3", "-5", "2x - 2"],
                    story: "üèπ Menara Sihir: Misi berhasil diselesaikan!",
                    icon: "üóº", question: "(f ‚àò g)(-2)", value: -2
                }
            ]
        };

        const bossQuestions = {
            1: [
                {
                    f: "x^3 + 2x^2 - x + 1", g: "x - 1", answer: "x^3 - x^2 - 2x + 2", type: "fog",
                    options: ["x^3 + 2x^2 - x", "x^3 - x^2 + 2x + 1", "x^3 - x^2 - 2x + 2", "x^3 + x^2 - 3x + 2"],
                    boss: "Goblin King", hp: 100,
                    description: "Raja Goblin menguasai fungsi kubik kompleks!",
                    question: "(f ‚àò g)(x)"
                },
                {
                    f: "2x^2 + 3x - 4", g: "x^2 + 1", answer: "x^4 + 2x^2 + 4", type: "gof",
                    options: ["2x^4 + 3x^2 - 4", "x^4 + 2x^2 + 4", "2x^4 + 2x^2 + 3x - 4", "2x^4 + 5x^2 - 1"],
                    boss: "Goblin King", hp: 100,
                    description: "Raja Goblin menguasai fungsi kubik kompleks!",
                    question: "(g ‚àò f)(x)"
                },
                {
                    f: "x^2", g: "2x - 1", h: "x + 3", answer: "4x^2 + 20x + 25", type: "triple",
                    options: ["4x^2 - 6x + 1", "4x^2 + 20x + 25", "2x^2 - 7x + 3", "4x^2 - 8x + 3"],
                    boss: "Goblin King", hp: 100,
                    description: "Raja Goblin menguasai fungsi kubik kompleks!",
                    question: "(f ‚àò g ‚àò h)(x)"
                }
            ],
            2: [
                {
                    f: "x^3 - 2x^2 + x - 3", g: "x + 2", answer: "x^3 + 4x^2 + 3x + 1", type: "fog",
                    options: ["x^3 + 2x^2 - x - 1", "x^3 - 2x^2 + x + 5", "x^3 + 6x^2 + 11x + 5", "x^3 + 4x^2 + 3x + 1"],
                    boss: "Dragon Lord", hp: 150,
                    description: "Naga Penguasa dengan fungsi polinomial tingkat tinggi!",
                    question: "(f ‚àò g)(x)"
                },
                {
                    f: "3x^2 - 4x + 1", g: "x^2 - 2x + 1", answer: "x^4 - 4x^3 + 7x^2 - 6x + 2", type: "gof",
                    options: ["3x^4 - 12x^3 + 13x^2 - 6x + 1", "x^4 - 4x^3 + 7x^2 - 6x + 2", "3x^4 - 16x^3 + 25x^2 - 10x + 2", "3x^4 - 4x^3 + x^2 - 2x + 1"],
                    boss: "Dragon Lord", hp: 150,
                    description: "Naga Penguasa dengan fungsi polinomial tingkat tinggi!",
                    question: "(g ‚àò f)(x)"
                },
                {
                    f: "2x^3 + x - 5", g: "x - 3", answer: "-52", type: "numerical",
                    options: ["-50", "-52", "-48", "-54"],
                    boss: "Dragon Lord", hp: 150,
                    description: "Naga Penguasa dengan fungsi polinomial tingkat tinggi!",
                    question: "(f ‚àò g)(0)", value: 0
                }
            ],
            3: [
                {
                    f: "x^4 - 2x^3 + x^2 - 1", g: "x + 1", answer: "x^4 + 2x^3 - x^2 + 2x", type: "fog",
                    options: ["x^4 - 2x^3 + x^2", "x^4 + 4x^3 + 6x^2 + 4x", "x^4 - x^2 - 1", "x^4 + 2x^3 - x^2 + 2x"],
                    boss: "Demon Emperor", hp: 200,
                    description: "Kaisar Iblis dengan fungsi derajat 4 yang mengerikan!",
                    question: "(f ‚àò g)(x)"
                },
                {
                    f: "3x^3 - 5x^2 + 2x - 7", g: "2x - 1", answer: "x^3 - 2x^2 + x - 2", type: "gof",
                    options: ["24x^3 - 36x^2 + 14x - 8", "x^3 - 2x^2 + x - 2", "24x^3 - 54x^2 + 37x - 10", "24x^3 - 60x^2 + 44x - 12"],
                    boss: "Demon Emperor", hp: 200,
                    description: "Kaisar Iblis dengan fungsi derajat 4 yang mengerikan!",
                    question: "(g ‚àò f)(x)"
                },
                {
                    f: "x^2 + 3x - 2", g: "x^3 - x + 1", h: "x - 1", answer: "x^9 - 3x^7 + 6x^6 - 3x^5 + 3x^4 - 6x^3 + 6x^2 - 3x + 1", type: "triple",
                    options: ["x^6 - x^4 + 4x^3 - x + 1", "x^6 + 6x^4 - 2x^3 + 3x^2 - 5x + 1", "x^5 + 3x^4 - 2x^3 - x + 1", "x^9 - 3x^7 + 6x^6 - 3x^5 + 3x^4 - 6x^3 + 6x^2 - 3x + 1"],
                    boss: "Demon Emperor", hp: 200,
                    description: "Kaisar Iblis dengan fungsi derajat 4 yang mengerikan!",
                    question: "(f ‚àò g ‚àò h)(x)"
                }
            ]
        };

        function startGame(mode) {
            gameState.mode = mode;
            gameState.score = 0;
            gameState.level = 1;
            gameState.lives = 3;
            gameState.streak = 0;
            gameState.totalAnswered = 0;
            gameState.totalCorrect = 0;
            gameState.questionsInLevel = 0;
            gameState.levelStartScore = 0;
            gameState.levelCorrectAnswers = 0;
            gameState.levelWrongAnswers = 0;
            gameState.powerups = { hints: 3, skips: 2, double: 1 };
            
            document.getElementById('gameMenu').classList.add('hidden');
            document.getElementById('gameArea').classList.remove('hidden');
            
            // Show/hide mode-specific elements
            if (mode === 'speed') {
                document.getElementById('timerArea').classList.remove('hidden');
                document.getElementById('powerupsArea').classList.add('hidden');
                document.getElementById('bossArea').classList.add('hidden');
                document.getElementById('storyArea').classList.add('hidden');
                startTimer();
            } else if (mode === 'adventure') {
                document.getElementById('timerArea').classList.add('hidden');
                document.getElementById('powerupsArea').classList.remove('hidden');
                document.getElementById('bossArea').classList.add('hidden');
                document.getElementById('storyArea').classList.remove('hidden');
            } else if (mode === 'boss') {
                document.getElementById('timerArea').classList.add('hidden');
                document.getElementById('powerupsArea').classList.remove('hidden');
                document.getElementById('bossArea').classList.remove('hidden');
                document.getElementById('storyArea').classList.add('hidden');
            }
            
            generateQuestion();
            updateUI();
        }

        function generateQuestion() {
            let questions;
            
            // Get questions for current level
            switch(gameState.mode) {
                case 'speed':
                    questions = speedQuestions[gameState.level] || speedQuestions[3];
                    break;
                case 'adventure':
                    questions = adventureQuestions[gameState.level] || adventureQuestions[3];
                    break;
                case 'boss':
                    questions = bossQuestions[gameState.level] || bossQuestions[3];
                    break;
            }
            
            // Get the specific question for this position in the level
            const questionIndex = gameState.questionsInLevel % gameState.maxQuestionsPerLevel;
            const question = questions[questionIndex];
            gameState.currentQuestion = question;
            
            // Update display based on mode
            if (gameState.mode === 'adventure') {
                document.getElementById('storyIcon').textContent = question.icon;
                document.getElementById('storyTitle').textContent = `Level ${gameState.level} - Petualangan`;
                document.getElementById('storyText').textContent = question.story;
            } else if (gameState.mode === 'boss') {
                if (gameState.questionsInLevel === 0) {
                    // New boss
                    gameState.boss.name = question.boss;
                    gameState.boss.maxHp = question.hp;
                    gameState.boss.currentHp = question.hp;
                }
                document.getElementById('bossName').textContent = question.boss;
                document.getElementById('bossDescription').textContent = question.description;
                updateBossHealth();
            }
            
            // Update function display based on question type
            let functionDisplayHTML = '';
            if (question.type === 'triple') {
                functionDisplayHTML = `
                    <div class="text-xl">
                        <span class="text-blue-300">f(x) = </span>
                        <span class="text-white font-mono">${question.f}</span>
                    </div>
                    <div class="text-xl">
                        <span class="text-green-300">g(x) = </span>
                        <span class="text-white font-mono">${question.g}</span>
                    </div>
                    <div class="text-xl">
                        <span class="text-purple-300">h(x) = </span>
                        <span class="text-white font-mono">${question.h}</span>
                    </div>
                    <div class="text-2xl text-yellow-400 mt-4">
                        Tentukan: <span>${question.question}</span>
                    </div>
                `;
            } else if (question.type === 'numerical') {
                functionDisplayHTML = `
                    <div class="text-xl">
                        <span class="text-blue-300">f(x) = </span>
                        <span class="text-white font-mono">${question.f}</span>
                    </div>
                    <div class="text-xl">
                        <span class="text-green-300">g(x) = </span>
                        <span class="text-white font-mono">${question.g}</span>
                    </div>
                    <div class="text-2xl text-yellow-400 mt-4">
                        Tentukan: <span>${question.question}</span>
                    </div>
                `;
            } else {
                functionDisplayHTML = `
                    <div class="text-xl">
                        <span class="text-blue-300">f(x) = </span>
                        <span class="text-white font-mono">${question.f}</span>
                    </div>
                    <div class="text-xl">
                        <span class="text-green-300">g(x) = </span>
                        <span class="text-white font-mono">${question.g}</span>
                    </div>
                    <div class="text-2xl text-yellow-400 mt-4">
                        Tentukan: <span>${question.question}</span>
                    </div>
                `;
            }
            
            document.getElementById('functionDisplay').innerHTML = functionDisplayHTML;
            
            // Update question number to show progress in level
            const questionInLevel = (gameState.questionsInLevel % gameState.maxQuestionsPerLevel) + 1;
            document.getElementById('questionNumber').textContent = `Soal ${questionInLevel}/3`;
            
            // Generate answer options
            const optionsHTML = question.options.map((option, index) => {
                const displayOption = question.type === 'numerical' ? option : `$${option}$`;
                return `<button onclick="selectAnswer('${option}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-xl p-4 text-lg font-mono transition-all transform hover:scale-105">
                    ${String.fromCharCode(65 + index)}) ${displayOption}
                </button>`;
            }).join('');
            
            document.getElementById('answerOptions').innerHTML = optionsHTML;
            
            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        function selectAnswer(answer) {
            gameState.totalAnswered++;
            gameState.questionsInLevel++;
            
            if (answer === gameState.currentQuestion.answer) {
                // Correct answer
                gameState.totalCorrect++;
                gameState.levelCorrectAnswers++;
                gameState.streak++;
                gameState.maxStreak = Math.max(gameState.maxStreak, gameState.streak);
                
                let points = 100 * gameState.level;
                if (gameState.mode === 'speed') points = 50;
                if (gameState.mode === 'boss') points = 200;
                if (gameState.streak >= 3) points *= 1.5;
                if (gameState.doubleActive) {
                    points *= 2;
                    gameState.doubleActive = false;
                }
                
                gameState.score += Math.floor(points);
                
                // Mode-specific effects
                if (gameState.mode === 'boss') {
                    const damage = Math.floor(gameState.boss.maxHp / 3); // 1/3 damage per correct answer
                    gameState.boss.currentHp = Math.max(0, gameState.boss.currentHp - damage);
                    showFeedback(true, `üí• Critical Hit! -${damage} HP! +${Math.floor(points)} poin`);
                    
                    if (gameState.boss.currentHp <= 0) {
                        showBossDefeated();
                        return;
                    }
                } else {
                    showFeedback(true, `Benar! +${Math.floor(points)} poin`);
                }
                
            } else {
                // Wrong answer
                gameState.levelWrongAnswers++;
                gameState.streak = 0;
                if (gameState.mode !== 'boss') {
                    gameState.lives--;
                }
                
                showFeedback(false, `Salah! Jawaban benar: $${gameState.currentQuestion.answer}$`);
                
                if (gameState.lives <= 0 && gameState.mode !== 'boss') {
                    endGame();
                    return;
                }
            }
            
            // Check if level is complete (3 questions answered)
            if (gameState.questionsInLevel % gameState.maxQuestionsPerLevel === 0) {
                showLevelComplete();
                return;
            }
            
            updateUI();
            
            setTimeout(() => {
                generateQuestion();
            }, 2500);
        }

        function showFeedback(isCorrect, message) {
            const feedback = document.createElement('div');
            feedback.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 p-6 rounded-xl text-center text-white font-bold text-xl ${isCorrect ? 'bg-green-500' : 'bg-red-500'}`;
            feedback.innerHTML = `
                <div class="text-4xl mb-2">${isCorrect ? 'üéâ' : 'üòû'}</div>
                <div>${message}</div>
            `;
            
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                document.body.removeChild(feedback);
            }, 2000);
        }

        function showLevelComplete() {
            // Calculate level statistics
            const levelScore = gameState.score - gameState.levelStartScore;
            const levelAccuracy = gameState.maxQuestionsPerLevel > 0 ? 
                Math.round((gameState.levelCorrectAnswers / gameState.maxQuestionsPerLevel) * 100) : 0;
            
            // Update level complete screen
            document.getElementById('completedLevel').textContent = gameState.level;
            document.getElementById('completedMode').textContent = 
                gameState.mode === 'speed' ? 'Speed Challenge' :
                gameState.mode === 'adventure' ? 'Adventure Mode' : 'Boss Battle';
            document.getElementById('levelScore').textContent = levelScore;
            document.getElementById('levelCorrect').textContent = gameState.levelCorrectAnswers;
            document.getElementById('levelWrong').textContent = gameState.levelWrongAnswers;
            document.getElementById('levelAccuracy').textContent = levelAccuracy + '%';
            
            // Hide game area and show level complete screen
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('levelCompleteScreen').classList.remove('hidden');
            
            // Start countdown to auto-return to menu
            let countdown = 5;
            document.getElementById('countdown').textContent = countdown;
            
            gameState.countdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('countdown').textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(gameState.countdownInterval);
                    backToMenu();
                }
            }, 1000);
        }

        function showLevelUp() {
            const levelUp = document.createElement('div');
            levelUp.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 bg-gradient-to-r from-yellow-400 to-orange-500 p-8 rounded-xl text-center text-white font-bold';
            levelUp.innerHTML = `
                <div class="text-6xl mb-4">üéä</div>
                <div class="text-3xl">LEVEL UP!</div>
                <div class="text-xl">Level ${gameState.level}</div>
                <div class="text-sm mt-2">3 soal baru menanti!</div>
            `;
            
            document.body.appendChild(levelUp);
            
            setTimeout(() => {
                document.body.removeChild(levelUp);
            }, 3000);
        }

        function showBossDefeated() {
            const bossDefeated = document.createElement('div');
            bossDefeated.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 bg-gradient-to-r from-yellow-400 to-orange-500 p-8 rounded-xl text-center text-white font-bold';
            bossDefeated.innerHTML = `
                <div class="text-6xl mb-4">üëë</div>
                <div class="text-4xl mb-2">BOSS DEFEATED!</div>
                <div class="text-2xl">${gameState.boss.name} telah dikalahkan!</div>
                <div class="text-xl mt-2">+1000 Bonus Points!</div>
            `;
            
            document.body.appendChild(bossDefeated);
            gameState.score += 1000;
            updateUI();
            
            setTimeout(() => {
                document.body.removeChild(bossDefeated);
                showLevelComplete();
            }, 4000);
        }

        function startTimer() {
            gameState.timer = 60;
            gameState.timerInterval = setInterval(() => {
                gameState.timer--;
                document.getElementById('timer').textContent = gameState.timer;
                
                if (gameState.timer <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function useHint() {
            if (gameState.powerups.hints > 0) {
                gameState.powerups.hints--;
                
                const options = document.querySelectorAll('#answerOptions button');
                const correctAnswer = gameState.currentQuestion.answer;
                let removed = 0;
                
                options.forEach(option => {
                    const optionText = option.textContent.split(') ')[1];
                    if (optionText !== correctAnswer && removed < 2) {
                        option.style.opacity = '0.3';
                        option.disabled = true;
                        removed++;
                    }
                });
                
                updateUI();
                showFeedback(true, 'Hint digunakan! 2 opsi salah dihilangkan');
            }
        }

        function skipQuestion() {
            if (gameState.powerups.skips > 0) {
                gameState.powerups.skips--;
                gameState.totalAnswered++;
                gameState.questionsInLevel++;
                gameState.levelWrongAnswers++; // Count skip as wrong for level stats
                
                // Check if level is complete
                if (gameState.questionsInLevel % gameState.maxQuestionsPerLevel === 0) {
                    showLevelComplete();
                    return;
                }
                
                updateUI();
                generateQuestion();
                showFeedback(true, 'Soal dilewati!');
            }
        }

        function activateDouble() {
            if (gameState.powerups.double > 0) {
                gameState.powerups.double--;
                gameState.doubleActive = true;
                updateUI();
                showFeedback(true, 'Double Score aktif untuk soal berikutnya!');
            }
        }

        function updateUI() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('lives').textContent = '‚ù§Ô∏è'.repeat(gameState.lives);
            document.getElementById('streak').textContent = gameState.streak;
            
            // Update progress indicator
            const questionInLevel = (gameState.questionsInLevel % gameState.maxQuestionsPerLevel) + 1;
            document.getElementById('progress').textContent = `${questionInLevel}/3`;
            
            if (gameState.mode !== 'speed') {
                document.getElementById('hintCount').textContent = gameState.powerups.hints;
                document.getElementById('skipCount').textContent = gameState.powerups.skips;
                document.getElementById('doubleCount').textContent = gameState.powerups.double;
            }
        }

        function updateBossHealth() {
            if (gameState.mode === 'boss') {
                const healthPercent = (gameState.boss.currentHp / gameState.boss.maxHp) * 100;
                document.getElementById('bossHp').style.width = healthPercent + '%';
                document.getElementById('bossHpText').textContent = `${gameState.boss.currentHp}/${gameState.boss.maxHp} HP`;
            }
        }

        function endGame() {
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.remove('hidden');
            
            const accuracy = gameState.totalAnswered > 0 ? Math.round((gameState.totalCorrect / gameState.totalAnswered) * 100) : 0;
            
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalLevel').textContent = gameState.level;
            document.getElementById('totalAnswered').textContent = gameState.totalAnswered;
            document.getElementById('totalCorrect').textContent = gameState.totalCorrect;
            document.getElementById('accuracy').textContent = accuracy + '%';
            document.getElementById('maxStreak').textContent = gameState.maxStreak;
            
            if (accuracy >= 80) {
                document.getElementById('gameOverEmoji').textContent = 'üèÜ';
                document.getElementById('gameOverTitle').textContent = 'Luar Biasa!';
            } else if (accuracy >= 60) {
                document.getElementById('gameOverEmoji').textContent = 'üéâ';
                document.getElementById('gameOverTitle').textContent = 'Bagus!';
            } else {
                document.getElementById('gameOverEmoji').textContent = 'üí™';
                document.getElementById('gameOverTitle').textContent = 'Terus Berlatih!';
            }
        }

        function restartGame() {
            document.getElementById('gameOverScreen').classList.add('hidden');
            startGame(gameState.mode);
        }

        function backToMenu() {
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            if (gameState.countdownInterval) {
                clearInterval(gameState.countdownInterval);
            }
            
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('levelCompleteScreen').classList.add('hidden');
            document.getElementById('gameMenu').classList.remove('hidden');
        }

        // Initialize game
        updateUI();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97b710fb82f36045',t:'MTc1NzI1NzEyOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
